"use strict";function toggleSpinner(a){console.log(a),a.find("i.icon-refresh").length>0?(console.log("removing spinner"),a.find("i.icon-refresh").remove()):(console.log("adding spinner"),a.append(' <i class="icon-refresh icon-spin"></i>'))}function storeInLocalStorage(a,b){console.log("storeInLocalStorage("+a+", "+b+")"),window.localStorage.setItem(b,JSON.stringify(a))}var mod=angular.module("ostosNero");mod.controller("MainCtrl",["$q","$http","$scope","$rootScope","$location",function(a,b,c,d,e){console.log("loaded: "+d.loaded),d.auth===!0&&(console.log("redir to list"),e.path("/list"))}]),mod.controller("RegisterCtrl",["$q","$http","$scope","$rootScope","$location",function(){}]),mod.controller("PassResetCtrl",function(){}),mod.controller("QuantSelectCtrl",function(){}),mod.controller("GlobalCtrl",["$scope",function(a){a.$back=function(){window.history.back()},a.$loading=function(a){return!!a},a.$close=function(){$(".alert").fadeOut(200)}}]),mod.controller("MenuCtrl",["$scope","$http","$q","$location",function(a,b,c,d){var e=window.innerWidth-46;$("#menu").width(e),a.go=function(a){console.log(a),d.url(a)},a.logout=function(){c.defer(),b({url:"../../api/logout"}).success(function(){location.reload()})}}]).controller("MenuLocationCtrl",["$scope","locationService",function(a,b){a.location={current:b.location.string,count:1}}]).controller("MenuListsCtrl",["$scope","listService",function(a,b){var c=b.data;a.listCount=c.attributes.quantity}]),mod.controller("LoginCtrl",["$q","$http","$scope","$rootScope","$location",function(a,b,c,d,e){function f(c,d){var e=a.defer();return console.log(c+", "+d),b({method:"GET",url:"../../api/login/",params:{email:c,password:d}}).success(function(a){console.log(a),void 0===a.success?e.reject("No connection to server could be made"):e.resolve(a)}).error(function(a){console.log(a),e.reject()}),e.promise}console.log("login controller"),c.error=!1,console.log(c.loginForm),c.hideError=function(){c.loginForm.$error.message=null},c.submit=function(){var a,b=c.loginUser,g=c.loginPass;c.loginForm.$setDirty(),console.log(c.loginForm),console.log(c.loginForm.$error),b&&0!==b.length?g&&0!==g.length?(toggleSpinner($('#login-form button[type="submit"]')),a=f(b,g),a.then(function(a){toggleSpinner($('#login-form button[type="submit"]')),a.error.length>0?c.loginForm.$error.message=a.error:(d.auth=!0,e.path("/list/"))},function(a){toggleSpinner($('#login-form button[type="submit"]')),c.loginForm.$error.message=a})):c.loginForm.$error.message="Password not entered":c.loginForm.$error.message="Email or username not entered"}}]),mod.controller("RegisterCtrl",["$scope","$http","$q","$accountsService",function(a,b,c,d){function e(a,d,e){var f=c.defer();return b({url:"../../api/register/",method:"GET",params:{email:a,name:d,pass:e}}).success(function(a){console.log(a),f.resolve(a)}).error(function(a){console.log(a),f.reject(a)}),f.promise}console.log(a.signupForm),a.hideError=function(){a.signupForm.$error.message=null},a.submit=function(){var b,c=a.registerEmail,f=a.registerUser,g=a.registerPass;console.log(a.signupForm),a.signupForm.$setDirty(),c&&0!==c.length?f&&0!==f.length?g&&0!==g.length?(b=e(c,f,g),toggleSpinner($('#signup-form-01 button[type="submit"]'))):a.signupForm.$error.message="no password entered":a.signupForm.$error.message="no username entered":a.signupForm.$error.message="no email entered",b.then(function(a){console.log(a),d.login(c,g).then(function(){location.reload()})},function(b){a.signupForm.$error.message=b,toggleSpinner($('#signup-form-01 button[type="submit"]'))})}}]),mod.controller("ListCtrl",["$q","$http","$rootScope","$scope","$location","storage","listService","scroller","sync",function(a,b,c,d,e,f,g,h,i){function j(b,c){console.log("add quant");var d=(a.defer(),parseInt(g.data.products[b].quantity));d+=c,console.log(d),g.data.products[b].quantity=d,f.set("userLists",g.data),i.quantity(b,d)}d.location=e.url(),console.log(e.url()),NProgress.start(),g.getNew().then(function(a){console.log("got list"),console.log(a),NProgress.done(),d.refreshing=!1,d.list=a},function(a){NProgress.done(),console.log("couldnt get list: "+a)}),d.hasList=!1,d.$on("$viewContentLoaded",function(){console.log("list page loaded")});var k=g.populate();k===!1?(NProgress.start(),console.log("no list in storage"),g.getNew().then(function(a){NProgress.done(),console.log("got new list"),d.list=a},function(a){console.log("getting list didnt work: "+a)})):(console.log("getting list"),d.list=k),d.getLists=function(){console.log("getLists()"),h.construct(document.getElementById("list-container")),NProgress.start(),d.refreshing=!0,g.getNew().then(function(a){console.log("got list"),console.log(a),NProgress.done(),d.refreshing=!1},function(a){NProgress.done(),console.log("couldnt get list: "+a)})},d.showMenu=function(a){console.log(a),d.openItem=null==d.openItem?a:null},$("#list-container").on("click",".list-item-menu .add, .list-item-menu .remove",function(a){a.preventDefault(),console.log("clicking da add/remove button")}),$("#list-container").on("click",".list-item-menu .add",function(){console.log("clicking da add button");var a;a=$(this).parent().data("id"),console.log(a),console.log(g.data),j(a,1)}),$("#list-container").on("click",".list-item-menu .remove",function(){console.log("clicking da remove button");var a;a=$(this).parent().data("id"),console.log(a),console.log(g.data),j(a,-1)}),d.productInfo=function(a){e.url("/list/"+a)},d.removeFromList=function(a){var b=g.data;delete b.products[a],console.log(b),f.set("userLists",b),g.remove(a)},d.sort=function(){e.url("/sort")}}]),mod.controller("ProductPageCtrl",["$scope","$rootScope","$http","$q","$routeParams","productInfo","storage","sync","spinner","listService","locationService","scroller",function(a,b,c,d,e,f,g,h,i,j,k,l){function m(){o.products[p].quantity=r,console.log(o.products[p].quantity),a.productInfo=o.products[p],g.set("userLists",o),console.log(a.productInfo.quantity)}function n(){r=o.products[p].quantity,console.log(r),console.log(p),h.quantity(p,r)}a.page={title:"product info"},a.$on("$viewContentLoaded",function(){NProgress.start()});var o,p,q,r;if(a.prices=!1,e.productID){a.inList=!1;var s=f.product(e.productID);s.then(function(b){NProgress.set(.5),console.log(b),a.productInfo=b},function(a){console.warn(a)})}else e.listItemID&&(a.inList=!0,p=e.listItemID,o=j.data,q=o.products[p],r=parseInt(q.quantity),console.log(q),console.log(r),a.productInfo=o.products[p],console.log(a.productInfo));console.warn(k.getCurrentLocation());var t,u,v,w=k.getCurrentLocation();w.then(function(b){console.log(e),t=b.coords.latitude,u=b.coords.longitude,v=q&&q.productID?q.productID:e.productID,f.getLocalPrices(v,{lat:t,"long":u}).then(function(b){NProgress.done(),a.prices=[],console.log(b),a.prices=b;for(var c in b)a.placeholder="",b[c].price||(a.placeholder="no price here yet");l.construct(document.getElementById("productPage"))},function(){})},function(a){if(NProgress.done(),a.code)switch(a.code){case 1:b.appError="Could not get location. \nOstosnero doesn't have permission to get location";break;case 2:b.appError="Could not find location";break;case 3:b.appError="Took too long finding your location"}console.warn(a)}),a.back=function(){console.log("back"),history.back()},a.increase=function(){r+=1,console.log(r),m()},a.decrease=function(){r-=1,console.log(r),m()},a.addProduct=function(){var a=($("#prodInfoAddBtn"),j.data),b=e.productID;j.add(a.attributes.id,b).then(function(a){console.log(a)},function(a){console.warn(a)})},console.log(k.location),a.updatePrice=function(a){a.waiting=!0,f.updatePrice(a.price,a.shopID,a.productId).then(function(){a.updated=!0,a.waiting=!1},function(a){console.warn(a)})};var x;$(".change-quant").bind("touchend mouseup",function(){console.log("end"),x=setTimeout(n,2e3),console.log(x)}),$(".change-quant").bind("touchstart mousedown",function(){console.log("start"),clearTimeout(x)})}]),mod.controller("LocationCtrl",["$scope","$q","$http","$location","storage","locationService",function(a,b,c,d,e,f){function g(){var a=!1;return e.retrieve("location.lat")&&e.retrieve("location.long")&&(a=!0),a}function h(){if(g()){var b=f.getAddress(e.retrieve("location.lat"),e.retrieve("location.long"));b.then(function(b){console.log(b),a.currentLocation=b,f.location.string=b,console.log(),$(".location-refresh").removeClass("icon-spin")},function(a){$(".location-refresh").removeClass("icon-spin"),console.log(a)})}}function i(){$(".location-refresh").addClass("icon-spin"),console.log("do we have the location: "+g());var b=f.getCurrentLocation();console.log(b),b.then(function(b){console.log("promise received"),console.log(b),e.add("location.lat",b.coords.latitude),e.add("location.long",b.coords.longitude),$(".chosen-location-icon").removeClass("error warn");var c=f.getAddress(b.coords.latitude,b.coords.longitude);c.then(function(b){console.log(b),a.currentLocation=b,$(".location-refresh").removeClass("icon-spin")},function(a){$(".location-refresh").removeClass("icon-spin"),console.log(a)})},function(b){switch(console.log(b),console.log("promise fail reason received"),$(".location-refresh").removeClass("icon-spin"),b.code){case 1:$(".chosen-location-icon").addClass("warn"),a.currentLocation="Location services not allowed";break;case 2:$(".chosen-location-icon").addClass("error"),a.currentLocation="Could not find location";break;case 3:$(".chosen-location-icon").addClass("error"),a.currentLocation="Could not find location"}})}a.page={title:"Location"},console.log("location controller"),a.currentLocation="Fetching location...",a.currentLocationEnabled=!0,a.locations=[],f.getCurrentLocation().then(function(b){a.currentCoords={lat:b.coords.latitude,"long":b.coords.longitude},console.log(a.currentCoords)}),a.openMap=function(){d.path("/location/map/"+a.currentCoords.lat+"/"+a.currentCoords.long)},a.refreshLocation=function(){i()},d.url("/location")&&h(),a.toggleCurrentLocation=function(){a.currentLocationEnabled=!a.currentLocationEnabled}}]),mod.controller("SearchCtrl",["$rootScope","$scope","$route","searchService","scroller","listService","storage",function(a,b,c,d,e,f,g){function h(){localStorage.searchResults&&(b.results=JSON.parse(localStorage.searchResults))}function i(){if(NProgress.start(),b.searchTerm.length>=3){console.log("valid search term, we'll send your shit now");var a=d.getResults(b.searchTerm);a.then(function(a){NProgress.done(),b.status="found",g.add("searchResults",a),console.log("found you some results"),b.results=a,e.construct(document.getElementById("product-search-results"))},function(a){NProgress.done(),console.log("something went wrong: "+a)})}}b.page={title:"Product Search"},b.$on("$routeChangeSuccess",function(a,b,c){"ProductPageCtrl"===c.controller&&h()});var j;$("#product-search-input").bind("keyup",function(){console.log("send stuff"),j=setTimeout(i,1e3)}),$("#product-search-input").bind("keydown",function(){console.log("stop sending stuff"),b.status="fetching",clearTimeout(j)}),b.addToList=function(c,d){console.log("addToList function."),console.log(a.listId),console.log(c),console.log(d),f.add(a.listId,c).then(function(a){1===a.success&&(b.success=d)},function(a){console.log(a)})}}]),mod.controller("SortCtrl",["$scope","sortService","listService","scroller","storage",function(a,b,c,d,e){function f(b){console.log(b),a.$apply(function(){a.currentList=b.segmentX}),console.log(j.scrollWidth);var c;c=b.segmentX>0?j.scrollWidth/b.segmentX:0,console.log(c),j.scrollTo(c,!1,!0)}console.log("sort controller"),a.sortedProducts="optimizing your list&hellip;",a.loading=!0,a.currentList=-1,a.back=function(){history.back()};var g,h,i,j,k,l=0;a.$on("$viewContentLoaded",function(){console.log("sort loaded"),$("#checkout-lists").height(document.height-$(".checkout-sums").outerHeight()),NProgress.start()}),a.checkoutObj=b.checked,a.checkout=function(d,e){console.log(d);var f=d.id,g=c.data.attributes.id,h=d.listItemId,i=d.shopid,j=d.quantity,k=d.price,l=d.saved;d.checking=1,a.checkedOut=null,b.checkout(e,f,j,h,g,i,k,l).then(function(a){d.checking=0,console.log(a),console.log(b.checked),console.log(b.checked[i].quantity),1===a.checked?(d.checkedOut=1,console.log(b.checked[i].quantity),b.checked[i].quantity++,b.checked[i].products[f]={productName:d.name,price:k,saved:l,quantity:j}):(delete b.checked[i].products[f],b.checked[i].quantity--,d.checkedOut=0)},function(a){d.checking=0,console.warn(a)})},a.navLinkScrollTo=function(a){console.log(a);var b=$(window).innerWidth()*a;k.scrollTo(b,!1,!0)},b.sort().then(function(c){NProgress.set(.3),console.log(c),a.currentList=0,g=$(".sorted-list-wrapper"),l=c.attributes.num_shops+1,g.width($(window).innerWidth()*l),h=$(window).innerWidth(),e.add("sort",c),a.sortedProducts=c;var d=0;for(var m in c.shops){console.log("shopNumber: "+d+"\nshop: "+m),a.sortedProducts.shops[m].shopNumber=d,console.log(m);var n=c.shops[m];b.checked[m]={shopId:n.attributes.id,shopName:n.attributes.chainName,shopLocation:n.attributes.chainLocation,quantity:0,open:!0,products:{}},d++}console.log(b.checked),setTimeout(function(){$(".sorted-list-nav").css({width:80*l+"pt"});var a={scrollingX:!0,scrollingY:!1,scrollbars:!1,contentHeight:$(window).innerHeight()-120,snapping:!0,paginatedSnap:!0,scrollResponseBoundary:8,scrollBoundary:20,bouncing:!1},b={scrollingX:!1,scrollResponseBoundary:1,scrollBoundary:15,updateOnChanges:!0},c={scrollingY:!1,scrollbars:!1,bouncing:!1};$(".sorted-list-shop-wrapper").each(function(a){console.log(a),$(this).width($(window).innerWidth()),$(this).css({left:$(window).innerWidth()*a}),"shop-checkout-summary"!==$(this).attr("id")&&(i=new FTScroller(document.querySelector("#"+$(this).attr("id")),b))}),k=new FTScroller(document.querySelector("#sorted-list-content"),a),k.addEventListener("segmentdidchange",f),j=new FTScroller(document.querySelector(".sorted-list-nav-wrapper"),c),NProgress.done()},300)},function(b){console.log("there's been a problem: "+b),a.loading=!1,NProgress.done()})}]),mod.controller("CheckoutCtrl",["$scope","sortService",function(a,b){function c(a){if(a===!1)return!1;a=parseFloat(a).toFixed(2);var b,c,d,e;return c=/^(\d+)(?!\.+)$/,d=/(\d+)\.([0-9]?)(?!\d)/,e=/(\d)(\.)([0-9]{2})\d/,b=a.toString(),b=b.match(c)?b.replace(c,"$1,00"):b.match(d)?b.replace(d,"$1,$20"):"0"===b?"0,00":b.replace(e,"$1,$3")}a.checked=b.checked,a.$on("$viewContentLoaded",function(){console.log($(window).innerHeight()-$(".checkout-sums").outerHeight())}),a.sum=function(){var a=0;for(var d in b.checked)for(var e in b.checked[d].products)a+=parseFloat(b.checked[d].products[e].price)*parseFloat(b.checked[d].products[e].quantity);return c(a)},a.saved=function(){var a=0;for(var d in b.checked)for(var e in b.checked[d].products)a+=parseFloat(b.checked[d].products[e].saved)*parseFloat(b.checked[d].products[e].quantity);return c(a)},a.toggle=function(a){void 0===a.open&&(a.open=!1),a.open=!a.open}}]),ostosNero.controller("MapCtrl",function(a,b,c,d){function e(){var a=d.defer();return c({url:"../../api/getClosestShops",method:"get",params:{lat:g,"long":h,num:30}}).success(function(b){a.resolve(b)}).error(function(b){a.reject(b)}),a.promise}function f(a){var b=[],c=[];console.log(a);for(var d=0;d<a.length;d++){console.log(d),c.push(d),console.log(a[d].chainName);var e=(new google.maps.LatLng(a[d].latitude,a[d].longitude),a[d].latitude),f=a[d].longitude,g="d_map_pin_letter",h="%E2%80%A2",i="FE7569",j="333333";switch(a[d].chainName.toLowerCase()){case"alepa":h="a",i="FFEC01",j="E20012";break;case"k-market":h="K",i="0038A8",j="FFFFFF";break;case"k-supermarket":h="K",i="0038A8",j="FFFFFF";break;case"k-citymarket":h="K",i="0038A8",j="FFFFFF";break;case"k-extra":h="K",i="0038A8",j="FFFFFF";break;case"m-ketju":h="M",i="B7001C",j="f7f7f7";break;case"s-market":h="S",i="FFEC01",j="0038A8";break;case"lidl":h="L",i="181884",j="FCE216";break;case"stockmann":h="S",i="266D4F",j="f7f7f7";break;case"prisma":h="P",i="009156",j="f7f7f7";break;case"siwa":h="s",i="F7F7F7",j="006CA9";break;case"valintatalo":h="V",i="F57840",j="F7F7F7";break;case"motorest":g="d_map_pin_icon",h="petrol",i="F57840",j="F7F7F7";break;case"neste oil":g="d_map_pin_icon",h="glyphish_fuel",i="F57840",j="F7F7F7"}new google.maps.MarkerImage("http://chart.apis.google.com/chart?chst="+g+"_withshadow&chld="+h+"|"+i+"|"+j,new google.maps.Size(21,34),new google.maps.Point(0,0),new google.maps.Point(10,34)),new google.maps.MarkerImage("http://chart.apis.google.com/chart?chst=d_map_pin_shadow",new google.maps.Size(40,37),new google.maps.Point(0,0),new google.maps.Point(12,35)),b.push({latitude:e,longitude:f,icon:"http://chart.apis.google.com/chart?chst="+g+"_withshadow&chld="+h+"|"+i+"|"+j,shadow:"http://chart.apis.google.com/chart?chst=d_map_pin_shadow"})}return b}var g=b.lat,h=b.long;a.pageTitle="closest shops",e().then(function(b){console.log(f(b)),angular.extend(a,{markers:f(b)})}),angular.copy(a.map),a.getMap=function(a){console.log("get map"),console.log(a)},new GeolocationMarker,console.log(a.map),google.maps.visualRefresh=!0,angular.extend(a,{center:{latitude:g,longitude:h},zoom:14})});